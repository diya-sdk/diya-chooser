<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">

<link rel="import" href="diya-chooser.html">


<polymer-element name="diya-chooser-dialog" attributes="selector forceAuth noAuth single">
	<template>
		<paper-button on-tap="{{actionToggle}}">Select diya...</paper-button>

		<style>

			paper-dialog {
				box-shadow: 0px 0px 15px #555;
				padding: 20px;
				background: white;
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				margin: 0px;
			}

			diya-chooser {
				width: 100%;
				flex: 1;
				padding: 0px;
			}

			paper-dialog > paper-button {
				position: absolute;
				top: 5px;
				right: 5px;
				display: none;
			}

			paper-dialog > paper-button.modal {
				display: initial ! important;
			}

			@media screen and (orientation: landscape) {
				paper-dialog.keyboard-overlay {
					top: 0px !important;
					height: 100px !important; /* arbitrary value as we will never know keyboard height */
				}
			}

			@media screen and (orientation: portrait) {
				paper-dialog.keyboard-overlay {
					top: 0px !important;
					height: 300px !important; /* arbitrary value as we will never know keyboard height */
				}
			}

			@media screen and (max-width: 480px) {
				paper-dialog {
					width: 100vw !important;
				}

				paper-dialog::shadow #scroller {
					max-width : initial !important;
				}
			}

			@media screen and (max-height: 300px) {
				paper-dialog{
					height: 100vh !important;
				}

				paper-dialog::shadow #scroller {
					max-height : initial !important;
				}
			}

			@media screen and (max-height: 300px) and (max-width: 480px) {
				paper-dialog > paper-button {
					display: initial ! important;
				}
			}

		</style>
		<paper-dialog id="dialog" layered="false">
			<paper-button id="close" on-tap="{{toggle}}">
				<paper-fab icon="close" mini title="close dialog" role="button" style="background: grey">
				</paper-fab>
			</paper-button>
			<diya-chooser id="chooser" selector="{{selector}}" single="{{single}}" forceAuth="{{forceAuth}}" noAuth="{{noAuth}}"></diya-chooser>
		</paper-dialog>
	</template>

	<script>

		Polymer({

			forceAuth: false,
			noAuth: false,
			single: false,

			ready: function(){
			},

			domReady: function() {
				var that = this;

				// always show close paper-dialog?
				if ( (window.innerHeight * window.innerWidth) / (300 * 480) < 1.5 ) {
					this.$.close.className = "modal";
				}

				// original screen size (approximate value, may be changed due to rotation)
				var orgSize = window.innerHeight * window.innerWidth;

				var bOverlay = false;

				// quick hack for virtual keyboard problem:
				function showVK() {
					if ( bOverlay || ( Math.abs(orgSize - window.innerHeight * window.innerWidth) / orgSize < 0.2) ) {
						// overlay keyboard
						bOverlay = true;

						// overide any existent class, wait for Polymer setup
						that.async(function() {
							that.$.dialog.className = "keyboard-overlay";
							that.$.dialog.notifyResize();
							// focus on input
							// input is already focus before paper-dialog css changed, we need to refocus again
							// input.blur();
							// input.focus();
						});
					} else {
						// non overlay type virtual keyboard
					}
				};

				// quick hack for virtual keyboard problem:
				function hideVK() {
					if (bOverlay) {
						// restore dialog css
						that.async(function() {
							that.$.dialog.className = "";
							// focus on input
							// input is already focus before paper-dialog css changed, we need to refocus again
							// input.blur();
							// input.focus();
						});
					}
				};

				function windowresize() {
					// during resize, paper-dialog's css hasn't been changed yet, so we need to delay our css
					// get current focused element
					var input = that.$.chooser.shadowRoot.activeElement;
					if (input && input.value != null) {// editable content, current focus is input or paper-input
						// input is already focus so virtual kb is up
						// guess the type of keyboard by apply threshold
						showVK();
					} else {
						hideVK();
					}
				};

				Array.prototype.forEach.call(this.$.chooser.shadowRoot.querySelectorAll("paper-input, input"), function(node) {
					node.addEventListener("focus", showVK);
					node.addEventListener("blur", hideVK);

					// node.addEventListener("focus", function(e) { console.log("focus", this, e); showVK();});
					// node.addEventListener("focusin", function(e) { console.log("focusin", this, e)});
					// node.addEventListener("focusout", function(e) { console.log("focusout", this, e)});
					// node.addEventListener("blur", function(e) { console.log("blur", this, e); hideVK();});

					// normally, onchange event is fired when element is about to lose focus
					// but for some unknown reason, the element is still focused ...
					// so we need to focus out to hide VK
					// onchange won't be fire if value isn't changed
					// node.addEventListener("change", function(e) { console.log("change", e)});
					node.addEventListener("keypress", function(e) {
						if (e.keyCode === 13) {
							// or e.keyIdentifier === "Enter" in chrome
							this.blur();
						}
					});
				});


				window.addEventListener("resize", windowresize);
			},

			toggle: function(){
				this.$.dialog.toggle();
			},

			show: function(){
				this.$.dialog.opened = true;
			},

			hide: function(){
				this.$.dialog.opened = false;
			},

			///////////////////////////////////////
			////////// Action handlers ////////////
			///////////////////////////////////////

			selectorChanged: function(){
				this.hide();
			},

			actionToggle: function(){
				this.toggle();
			}
		});
	</script>
</polymer-element>
