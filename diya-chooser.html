<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-fab/paper-fab.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-toast/paper-toast.html">

<script type="text/javascript" src="../diya-sdk/dist/diya-sdk.js"></script>

<script type="text/javascript">
	if (!String.prototype.startsWith) {
		String.prototype.startsWith = function (searchString, position) {
			position = position || 0;
			return this.indexOf(searchString, position) === position;
		};
	}
</script>


<polymer-element name="diya-chooser" attributes="selector single forceAuth noAuth">
	<template>
		<style>

			:host{
				display: flex;
				flex-direction: column;
				padding: 10px;
				background: white;
			}

			h3{
				text-align: center;
				margin: -10px;
				margin-bottom: 10px;
				padding-top: 10px;
				font-size: 1.4em;
			}

			#content{
				width: 100%;

				flex: 1;

				display: flex;
				flex-direction: row;
				justify-content: center;
			}

			#servers{
				display: flex;
				flex-direction: column;
				flex: 1;
				padding-right: 10px;

			}

			#nodes{
				flex: 1;
				padding-left: 10px;
			}

			#serverInputSection{

				display: flex;
				flex-direction: row;
				align-items: center;
				justify-content: left;
			}

			#serverEntries{
				overflow: auto;
				flex: 1;

			}

			.serverEntry, .nodeEntry{
				display: flex;
				align-items: center;
				border-radius: 0px 30px 30px 0px;
				margin: 5px;
				box-shadow: 0px 0px 4px #555;
				background: lightgray;
			}

			.serverEntry p{
				margin: 0px;
				margin-left: 5px;
			}

			.disconnected{
				background: gray;
			}

			.connected{
				background: green;
			}

			.unreachable{
				background: red;
			}


			.nodeEntry p{
				margin: 10px;
			}

			.nodeEntry paper-checkbox{
				margin-right: 10px;

			}

			paper-checkbox::shadow #ink[checked] {
				color: rgb(1, 145, 197);
			}

			paper-checkbox::shadow #checkbox.checked {
				background: rgb(1, 145, 197);
			}

			#footer{
				display: flex;
				border-top: 1px solid lightgray;
				height: 60px;
				justify-content: space-between;
			}

			#auth{
				display: flex;
				align-items: center;
				justify-content: flex-start;

			}

			#userInput{
				margin-right: 10px;
			}

			.authenticated{
				background: green;
			}

			.notAuthenticated{
				background: gray;
			}

			.cannotAuthenticate{
				background: red;
			}

			#authenticatedMsg{
				flex: 1;
				display: flex;
			}

			#authenticatedMsg div{
				display: flex;
				justify-content: center;
				align-items: center;
				background: lightgray;
				border-radius: 30px;
			}

			#authenticatedMsg p{
				margin: 0px;
				margin-left: 20px;
				margin-right: 10px;

				font-size: 1.2em;
			}

			#status{
				display: flex;
				justify-content: flex-end;
				align-self: center;
				flex: 1;
			}

			#select{
				margin: 0px;
				padding: 0px;
				border-radius: 30px;
				background: lightgray;
				display: flex;
				justify-content: flex-end;
				align-items: center;
			}

			#select p{
				margin: 0px;
				margin-right: 10px;
				margin-left: 20px;
				font-size: 1.2em;
				padding: 0px;
			}

			@media screen and (max-device-width: 480px), screen and (orientation: portrait){
				#content, #auth, #footer{
					flex-direction: column;
				}

				#footer{
					height: auto;
					align-items: stretch;
				}

				#status{
					align-self: stretch;
					margin-top: 10px;
				}

			}

		</style>
		<div id="content">
			<section id="servers">
				<h4>Servers</h4>
				<section id="serverInputSection">
					<paper-input id="serverInput" flex label="add server..."></paper-input>
					<paper-fab
						icon="add"
						mini
						title="add server"
						role="button"
						on-tap="{{actionAddServer}}"
						style="background: green">
					</paper-fab>
				</section>
				<section id="serverEntries">
					<template repeat="{{server, i in servers}}">
						<section class="serverEntry">
							<paper-fab mini class="{{server.status}}"></paper-fab>
							<p flex>{{server.addr}}</p>
							<paper-fab
								icon="delete"
								mini
								title="add server"
								role="button"
								server-id="{{i}}"
								on-tap="{{actionDeleteServer}}"
								style="background: gray">
							</paper-fab>
							<paper-fab
								icon="arrow-forward"
								mini
								title="add server"
								role="button"
								server-id="{{i}}"
								on-tap="{{actionConnectServer}}"
								style="background: rgb(1, 145, 197)">
							</paper-fab>
						</section>
					</template>
				</section>
			</section>

			<section id="nodes">
				<h4>Robots</h4>
				<template repeat="{{node, i in nodes}}">
					<section class="nodeEntry">
						<paper-fab mini class="{{node.authenticated}}"></paper-fab>
						<p flex>{{node.name}}</p>
						<paper-checkbox node-id="{{i}}" checked="{{node.selected}}" on-tap="{{actionNodeSelected}}"></paper-checkbox>
					</section>
				</template>
			</section>
		</div>
		<section id="footer">
			<template if="{{!authenticated&&!noAuth}}">
				<section id="auth">
					<paper-input-decorator label="username..." floatinglabel>
		   				<input id="userInput" is="core-input" />
					</paper-input-decorator>
					<paper-input-decorator label="password..." floatinglabel>
		   				<input id="passwordInput" is="core-input" type="password" />
					</paper-input-decorator>
					<paper-fab
						icon="arrow-forward"
						mini
						title="Authenticate"
						role="button"
						on-tap="{{actionAuthenticate}}"
						style="background: rgb(1, 145, 197)">
					</paper-fab>
				</section>
			</template>
			<section id="status">
				<template if="{{authenticated}}">
					<section id="authenticatedMsg">
						<div>
							<p>logout</p>
							<paper-fab
								icon="clear"
								mini
								title="Deauthenticate"
								role="button"
								on-tap="{{actionDeauthenticate}}"
								style="background: gray">
							</paper-fab>
						</div>
					</section>
				</template>
				<div id="select">
					<p>select</p>
					<paper-fab
						mini
						icon="check"
						title="Deauthenticate"
						role="button"
						on-tap="{{actionSelect}}"
						style="background: green">
					</paper-fab>
				</div>
			</section>
		</section>

		<paper-toast id="authToast" text="You must be authenticated !"></paper-toast>

	</template>
	<script>
		Polymer({

			forceAuth: false,
			noAuth: false,
			single: false,

			ready: function(){
				var that = this;

				this.nodes = [];
				this.servers = [];

				this.authenticated = false;

				this.selector = null;

				d1.on('open', function(addr){
					that.onServerConnected(addr);
				}).on('close', function(addr, err){
					that.onServerDisconnected(addr, err);
				});

				d1(/.*/).listen()
				.on('peer-connected', function(peerId){
					that.addNode(peerId);
				})
				.on('peer-disconnected', function(peerId){
					that.removeNode(peerId);
				});

				this.retrieveServerSettings();
			},

			show: function(){
				this.style.display = 'flex';
			},

			hide: function(){
				this.style.display = 'none';
			},

			/////////////////////////////////////////////////////////////
			/////////////// Node related methods ////////////////////////
			/////////////////////////////////////////////////////////////

			addNode: function(dn){
				for(var i=0;i<this.nodes.length;i++){
					if(this.nodes[i].name === dn) return false;
				}
				this.nodes.push({name: dn, authenticated: 'notAuthenticated', selected: false});
				return true;
			},

			removeNode: function(dn){
				for(var i=0;i<this.nodes.length;i++){
					if(this.nodes[i].name === dn) {
						this.nodes.splice(i, 1);
						return true;
					}
				}
				return false;
			},

			authenticate: function(user, password, selectedNodes){
				var that = this;

				d1(selectedNodes).auth(user, password, function(nodeId, authenticated){
					that.authenticated = true;
				});
			},


			/////////////////////////////////////////////////////////////
			////////////////////// Server related methods ///////////////
			/////////////////////////////////////////////////////////////

			retrieveServerSettings: function(){
				var savedServerSettingsStr = localStorage.getItem('diya.chooser.servers');
				if(savedServerSettingsStr){
					try{
						var savedServerSettings = JSON.parse(savedServerSettingsStr);

						if(Array.isArray(savedServerSettings)){
							for(var i=0;i<savedServerSettings.length;i++){
								this.addServer(savedServerSettings[i]);
							}
						}
					}catch(e){
						//ignore settings
					}
				}
			},

			saveServerSettings: function(){
				var serverSettings = this.servers.map(function(s){return s.addr});
				var serverSettingsStr = JSON.stringify(serverSettings);

				localStorage.setItem('diya.chooser.servers', serverSettingsStr);
			},

			addServer: function(addr){

				if(!addr.startsWith('ws://') && !addr.startsWith('wss://')){
					addr = 'ws://' + addr;
				}

				for(var i=0;i<this.servers.length; i++){
					if(this.servers[i].addr === addr) return false;
				}
				this.servers.push({addr: addr, status: 'disconnected'});

				this.saveServerSettings();

				return true;
			},

			removeServer: function(index){
				var server = this.servers[index];
				if(server.addr === d1.currentServer())	d1.disconnect();

				this.servers.splice(index, 1);

				this.saveServerSettings();
			},

			getServer: function(addr){
				for(var i=0; i<this.servers.length; i++){
					if(this.servers[i].addr === addr) return this.servers[i];
				}
				return null;
			},

			connectServer: function(index){
				var that = this;

				that.authenticated = false;

				this.servers.forEach(function(s){
					s.status = 'disconnected';
				});

				d1.connect(this.servers[index].addr).catch(function(err){
					that.servers[index].status = 'unreachable';
				});
			},

			onServerConnected: function(addr){
				var server = this.getServer(addr);
				if(server) server.status = 'connected';
			},

			onServerDisconnected: function(addr){
				var server = this.getServer(addr);
				if(server) server.status = 'disconnected';
			},


			/////////////////////////////////////////////////////////////
			///////////////////// Action Handlers ///////////////////////
			/////////////////////////////////////////////////////////////

			actionAddServer: function(evt){
				var serverAddr = this.$.serverInput.value;
				this.addServer(serverAddr);
			},

			actionDeleteServer: function(evt){
				var index = parseInt(evt.target.attributes['server-id'].value);
				this.removeServer(index);
			},

			actionConnectServer: function(evt){
				var index = parseInt(evt.target.attributes['server-id'].value);
				this.connectServer(index);
			},

			actionAuthenticate: function(evt){
				var user = this.$.userInput.value;
				var password = this.$.passwordInput.value;
				var selectedNodes = this.nodes.map(function(n){return n.name});

				this.authenticate(user, password, selectedNodes);
			},

			actionDeauthenticate: function(evt){
				this.authenticated = false;
				d1.deauthenticate();
				this.selector = null;
			},

			actionNodeSelected: function(evt){
				if(!this.single) return ;

				//In single mode, only one node can be selected at a time
				var nodeId = parseInt(evt.target.attributes["node-id"].value);
				for(var i=0; i<this.nodes.length; i++) {
					if(i !== nodeId) this.nodes[i].selected = false;
				}
			},

			actionSelect: function(evt){
				if(this.forceAuth && !this.authenticated) {
					this.$.authToast.show();
					return ;
				}

				//creates an array of the names of the selected robots
				this.selector = this.nodes.filter(function(n){return n.selected;}).map(function(n){return n.name;});
			}
		});
	</script>



</polymer-element>
