<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-checkbox/paper-checkbox.html">

<script type="text/javascript" src="bower_components/diya-sdk/dist/diya-sdk.js"></script>


<polymer-element name="diya-chooser" attributes="selector">
	<template>
		<style>

			:host{
				display: flex;
				flex-direction: column;
				padding: 10px;
			}

			h3{
				text-align: center;
				margin: -10px;
				margin-bottom: 10px;
				background: rgb(1, 145, 197);
				color: white;
			}

			#content{
				width: 100%;

				flex: 1;

				display: flex;
				flex-direction: row;
				justify-content: center;
			}

			#servers{
				flex: 1;
				border-right: 1px dashed gray;
				padding-right: 10px;

			}

			#nodes{
				flex: 1;
				padding-left: 10px;
			}

			#serverInputSection{

				display: flex;
				flex-direction: row;
				align-items: center;
				justify-content: left;
			}

			.serverEntry{
				display: flex;
				align-items: center;
				border-radius: 0px 30px 30px 0px;
				padding: 5px;
			}

			.serverEntry p{
				margin: 0px;
			}

			.connected{
				background: green;
			}

			.unreachable{
				background: red;
			}

			.nodeEntry{
				display: flex;
				align-items: center;
			}

			.nodeEntry p{
				margin: 10px;
			}

		</style>

		<h3>Select a robot...</h3>

		<div id="content">
			<section id="servers">
				<h4>Servers</h4>
				<section id="serverInputSection">
					<paper-input id="serverInput" flex label="add server..."></paper-input>
					<paper-fab
						icon="add"
						mini
						title="add server"
						role="button"
						on-tap="{{actionAddServer}}"
						style="background: green">
					</paper-fab>
				</section>
				<template repeat="{{server, i in servers}}">
					<section class="serverEntry {{server.status}}">
						<p flex>{{server.addr}}</p>
						<paper-fab
							icon="delete"
							mini
							title="add server"
							role="button"
							server-id="{{i}}"
							on-tap="{{actionDeleteServer}}"
							style="background: gray">
						</paper-fab>
						<paper-fab
							icon="arrow-forward"
							mini
							title="add server"
							role="button"
							server-id="{{i}}"
							on-tap="{{actionConnectServer}}"
							style="background: rgb(1, 145, 197)">
						</paper-fab>
					</section>
				</template>
			</section>

			<section id="nodes">
				<h4>Robots</h4>
				<template repeat="{{node, i in nodes}}">
					<section class="nodeEntry">
						<p flex>{{node}}</p>
						<paper-checkbox node-id="{{i}}"></paper-checkbox>
					</section>
				</template>
			</section>
		</div>

	</template>
	<script>
		Polymer({
			ready: function(){
				var that = this;

				this.nodes = [];
				this.servers = [];

				d1(/.*/).listen()
					.on('peer-connected', function(peerId){
						that.addNode(peerId);
					})
					.on('peer-disconnected', function(peerId){
						that.removeNode(peerId);
					});

			},

			addNode: function(dn){
				for(var i=0;i<this.nodes.length;i++){
					if(this.nodes[i] === dn) return false;
				}
				this.nodes.push(dn);
				return true;
			},

			removeNode: function(dn){
				for(var i=0;i<this.nodes.length;i++){
					if(this.nodes[i] === dn) {
						this.nodes.splice(i, 1);
						return true;
					}
				}
				return false;
			},


			addServer: function(addr){
				this.servers.push(addr);
			},

			removeServer: function(index){
				this.servers.splice(index, 1);
			},

			connectServer: function(index){
				var that = this;

				this.servers.forEach(function(s){
					s.status = 'disconnected';
				});

				d1.connect('ws://'+this.servers[index].addr).then(function(){
					that.onServerConnected(index);
				}).catch(function(err){
					console.log(err);
					that.onServerConnectionFailed(index);
				});
			},

			onServerConnected: function(index){
				this.servers[index].status = 'connected';
			},

			onServerConnectionFailed: function(index){
				this.servers[index].status = 'unreachable';
			},

			actionAddServer: function(evt){
				var serverAddr = this.$.serverInput.value;
				this.addServer({addr: serverAddr, status: 'disconnected'});
			},

			actionDeleteServer: function(evt){
				var index = parseInt(evt.target.attributes['server-id'].value);
				this.removeServer(index);
				d1.disconnect();
			},

			actionConnectServer: function(evt){
				var index = parseInt(evt.target.attributes['server-id'].value);
				this.connectServer(index);
			}
		});
	</script>



</polymer-element>
